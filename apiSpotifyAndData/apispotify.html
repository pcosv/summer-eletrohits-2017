<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script type="text/javascript" src= "urls.json"></script>
	<script type="text/javascript" src= "trackArtists.json"></script>
	<script type="text/javascript" src= "trackArtistsById.json"></script>
	<script type="text/javascript" src= "trackFeatures.json"></script>
	<script type="text/javascript" src= "artistsGenres.json"></script>
	<script type="text/javascript" src= "idsByCountry.json"></script>
	<script type="text/javascript" >

		var uri = '';
		var genre = '';
		var respostaArtists = new Array();
		var respostaFeatures = new Array();
		var respostaGenres = new Array();
		var count = 0;
		var token = 'BQClvVJtq5qjm7dCZ1q47vMaSk369Ll8x3XC56GmhnLnOmJSPr4_vWE2fHxRSUb5qV0tDmqwDdc6ezLZjfTmSQJS5Zocn65B8o5cuUaXuRHmsOmo5fEhcfVMSNDihb8koBA26KWN8b86vx5NbQIlU2St';

		function download(data, filename, type) {
			var file = new Blob([data], {type: type});
			if (window.navigator.msSaveOrOpenBlob) // IE10+
				window.navigator.msSaveOrOpenBlob(file, filename);
			else { // Others
				var a = document.createElement("a"),
					url = URL.createObjectURL(file);
				a.href = url;
				a.download = filename;
				document.body.appendChild(a);
				a.click();
				setTimeout(function() {
					document.body.removeChild(a);
					window.URL.revokeObjectURL(url);  
				}, 0); 
			}
		}
			
		respostaArtistsString = '';
		function getArtists(){
			counter = 0;
			respostaArtistsString = '{';
			for(var i = 0; i < countries.length; i++){
				uri = '';
				for(var j=0; j < idsByCountry[countries[i]].length; j++){

					if(!((j+1)%50 == 0 || j == idsByCountry[countries[i]].length-1)){
						uri += idsByCountry[countries[i]][j] + ',';
					} else {
						uri += idsByCountry[countries[i]][j];

						setTimeout(function(counter, j, uri, market) {

							$.ajax({
								url: 'https://api.spotify.com/v1/tracks?ids=' + uri+'&market='+market,
								type: 'GET',
								headers: {
									'Authorization' : 'Bearer ' + token
								}, success: function(data) {

									for (var k = 0; k <= j%50; k++) {
										// if(respostaArtistsString.length >1){
										// 	respostaArtistsString+= ",\""+data["tracks"][k]["id"]+"\" :{ \"id\" :\""+data["tracks"][k]["artists"][0]["id"]+"\", \"name\" : \""+data["tracks"][k]["artists"][0]["name"].replace('"', "'").replace('"', "'").replace("\\", "")+"\"}";
										// } else {
										// 	respostaArtistsString+= "\""+data["tracks"][k]["id"]+"\" :{ \"id\" :\""+data["tracks"][k]["artists"][0]["id"]+"\", \"name\" : \""+data["tracks"][k]["artists"][0]["name"].replace('"', "'").replace('"', "'").replace("\\", "")+"\"}";
										// }
										respostaArtists = respostaArtists.concat(JSON.parse( "{\"song\":\""+data["tracks"][k]["id"]+"\", \"id\" :\""+data["tracks"][k]["artists"][0]["id"]+"\", \"name\" : \""+data["tracks"][k]["artists"][0]["name"].replace('"', "'").replace('"', "'").replace("\\", "")+"\"}" ));
									}
								}
							});
							uri = '';
							console.log(counter);
						}, 120*counter, counter, j, uri, countries[i]);
						counter++;
						uri = '';
					}
				}
			}
		}

		// download(JSON.stringify(JSON.parse(respostaArtistsString+'}'), null, "\t"), "trackArtists.json", "text/plain");
		// download(JSON.stringify(respostaArtists, null, "\t"), "trackArtists.json", "text/plain");

		function getFeatures(){
			for(var i = 0; i < 217; i++){

				setTimeout(function(count) {

					for (var j = 0; j < 100; j++) {
					
						uri += urls[count][j][0] + ',';

					}
					$.ajax({
						url: 'https://api.spotify.com/v1/audio-features?ids=' + uri,
						type: 'GET',
						headers: {
							'Authorization' : 'Bearer ' + token
						}, success: function(data) {
							respostaFeatures = respostaFeatures.concat(data["audio_features"]);
						}
					});
					uri = '';
	
				}, 120*i, i);
			}
		}

		// download(JSON.stringify(respostaFeatures, ["id", "energy", "loudness", "speechiness", "instrumentalness", "liveness", "valence", "danceability", "acousticness", "tempo"], "\t"), "trackFeatures.json", "text/plain");
		genres='';
		function getGenres(){

			var uris = '';
			for(var i = 0; i < 21700; i++){
				if(uris){
					uris += ','+respostaArtists[i]["id"];
				} else {
					uris += respostaArtists[i]["id"];
				}
				
				if((i+1)%50 === 0 || i == 21700){

					setTimeout(function(uri) {

					$.ajax({
						url: 'https://api.spotify.com/v1/artists?ids=' + uri ,
						type: 'GET',
						headers: {
							'Authorization' : 'Bearer ' + token
						}, success: function(data) {
								for (var j = 0; j < 50; j++) {
									if(!genres){
										genres += "{ \""+data["artists"][j]["id"]+"\" : \"/"+data["artists"][j]["genres"].join('/')+"/\""
									} else {
										genres += ", \""+data["artists"][j]["id"]+"\" : \"/"+data["artists"][j]["genres"].join('/')+"/\"";
									}
								}
							}
						});
					}, 120*(i+1)/50, uris,(i+1)/50);

					uris = '';
				}
				// respostaGenres = JSON.parse(genres+"}");

				// for (var i = 0; i < 21700; i++){
				// 	respostaArtists[i].genres = respostaGenres[respostaArtists[i]["id"]];
				// }
			}
		}

		// download(JSON.stringify(respostaGenres, null, "\t"), "artistsGenres.json", "text/plain");

	</script>
</head>
<body>
</body>
</html>