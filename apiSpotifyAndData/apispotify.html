<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script type="text/javascript" src= "urls.json"></script>
	<script type="text/javascript" src= "trackArtists.json"></script>
	<script type="text/javascript" src= "trackArtistsById.json"></script>
	<script type="text/javascript" src= "trackFeatures.json"></script>
	<script type="text/javascript" src= "artistsGenres.json"></script>
	<script type="text/javascript" src= "idsByCountry.json"></script>
	<script type="text/javascript" src= "distinctArtists.json"></script>
	<script type="text/javascript" >

		var uri = '';
		var genre = '';
		var respostaArtists = new Array();
		var respostaFeatures = new Array();
		var respostaGenres = new Array();
		var count = 0;
		var token = 'BQALV6uyvMYIj4m53necRBhnY7kNad-LtGFEKg3KhT8JoZPHTJePMVm1exYwhyVwwSbf7nBExPop8acqIcToLTuP_uz_hO5nxUuLH8AaQ3f9zGmjwY0jz2TTZTYdKqfr0iDEIEaLJvdGg6px8go5jpF1';

		function download(data, filename, type) {
			var file = new Blob([data], {type: type});
			if (window.navigator.msSaveOrOpenBlob) // IE10+
				window.navigator.msSaveOrOpenBlob(file, filename);
			else { // Others
				var a = document.createElement("a"),
					url = URL.createObjectURL(file);
				a.href = url;
				a.download = filename;
				document.body.appendChild(a);
				a.click();
				setTimeout(function() {
					document.body.removeChild(a);
					window.URL.revokeObjectURL(url);  
				}, 0); 
			}
		}
			
		// respostaArtistsString = '';
		function getArtists(){
			counter = 0;
			// respostaArtistsString = '{';
			for(var i = 0; i < countries.length; i++){
				uri = '';
				for(var j=0; j < idsByCountry[countries[i]].length; j++){

					if(!((j+1)%50 == 0 || j == idsByCountry[countries[i]].length-1)){
						uri += idsByCountry[countries[i]][j] + ',';
					} else {
						uri += idsByCountry[countries[i]][j];

						setTimeout(function(uri, market) {
							console.log(uri);
							$.ajax({
								url: 'https://api.spotify.com/v1/tracks?ids=' + uri + '&market=' + market,
								type: 'GET',
								headers: {
									'Authorization' : 'Bearer ' + token
								}, success: function(data) {
									console.log(uri);
									// console.log(data['tracks']);
									// for (var k = 0; k <= j%50; k++) {
										// if(respostaArtistsString.length >1){
										// 	respostaArtistsString+= ",\""+data["tracks"][k]["id"]+"\" :{ \"id\" :\""+data["tracks"][k]["artists"][0]["id"]+"\", \"name\" : \""+data["tracks"][k]["artists"][0]["name"].replace('"', "'").replace('"', "'").replace("\\", "")+"\"}";
										// } else {
										// 	respostaArtistsString+= "\""+data["tracks"][k]["id"]+"\" :{ \"id\" :\""+data["tracks"][k]["artists"][0]["id"]+"\", \"name\" : \""+data["tracks"][k]["artists"][0]["name"].replace('"', "'").replace('"', "'").replace("\\", "")+"\"}";
										// }
										// respostaArtists = respostaArtists.concat(JSON.parse( "{\"song\":\""+data["tracks"][k]["id"]+"\", \"id\" :\""+data["tracks"][k]["artists"][0]["id"]+"\", \"name\" : \""+data["tracks"][k]["artists"][0]["name"].replace('"', "'").replace('"', "'").replace("\\", "")+"\"}" ));
									// }
									respostaArtists = respostaArtists.concat(data["tracks"]);
								}
							});
						}, 200*counter, uri, countries[i]);
						counter++;
						uri = '';
					}
				}
			}
		}

		// download(JSON.stringify(JSON.parse(respostaArtistsString+'}'), null, "\t"), "trackArtists.json", "text/plain");
		// download(JSON.stringify(respostaArtists, null, "\t"), "trackArtists.json", "text/plain");

		function getFeatures(){
			for(var i = 0; i < 217; i++){

				setTimeout(function(count) {

					for (var j = 0; j < 100; j++) {
					
						uri += urls[count][j][0] + ',';

					}
					$.ajax({
						url: 'https://api.spotify.com/v1/audio-features?ids=' + uri,
						type: 'GET',
						headers: {
							'Authorization' : 'Bearer ' + token
						}, success: function(data) {
							respostaFeatures = respostaFeatures.concat(data["audio_features"]);
						}
					});
					uri = '';
	
				}, 120*i, i);
			}
		}

		// download(JSON.stringify(respostaFeatures, ["id", "energy", "loudness", "speechiness", "instrumentalness", "liveness", "valence", "danceability", "acousticness", "tempo"], "\t"), "trackFeatures.json", "text/plain");
		genres=[];
		function getGenres(){

			for(var i = 0; i < distinctArtists.length; i++){

				if(uri){
					uri += ','+distinctArtists[i]['id'];
				} else {
					uri += distinctArtists[i]['id'];
				}

				if((i+1)%50 === 0 || i == distinctArtists.length-1){

					setTimeout(function(uri) {

					$.ajax({
						url: 'https://api.spotify.com/v1/artists?ids=' + uri ,
						type: 'GET',
						headers: {
							'Authorization' : 'Bearer ' + token
						}, success: function(data) {

								console.log(data['artists']);
								for (var j = 0; j < data["artists"].length; j++) {
										genres.push([data["artists"][j]["id"], "/"+data["artists"][j]["genres"].join('/')+"/"]);
								}
							}
						});
					}, 120*(i+1)/50, uri);

					uri = '';
				}
				// respostaGenres = JSON.parse(genres+"}");

				// for (var i = 0; i < 21700; i++){
				// 	respostaArtists[i].genres = respostaGenres[respostaArtists[i]["id"]];
				// }
			}
		}

		// download(JSON.stringify(respostaGenres, null, "\t"), "artistsGenres.json", "text/plain");

		function allCsv(){

			for(var i = 0; i<21697; i++){
			    for(var j = 0; j<21700; j++){
			        if (trackFeatures[i]["id"] == trackArtists[j]["song"]){
			            trackFeatures[i].artist_name = trackArtists[j]["name"];
			            trackFeatures[i].artist_id = trackArtists[j]["id"];
			            trackFeatures[i].genres = trackArtists[j]["genres"];
			        	break;
			   		}
			    }
			}

			var csv = 'id,artist_id,artist_name,genres,energy,instrumentalness,liveness,loudness,speechiness,valence,danceability,acousticness,tempo\n'
			for(var i = 0; i<21697; i++){
			    if(trackFeatures[i] != null){
					if(typeof trackFeatures[i]["artist_name"] == "string"){
			        	trackFeatures[i]["artist_name"]= trackFeatures[i]["artist_name"].replace(',','').replace(',','');
					}
					csv += trackFeatures[i]["id"]+','+trackFeatures[i]["artist_id"]+','+trackFeatures[i]["artist_name"]+','+trackFeatures[i]["genres"]+','+trackFeatures[i]["energy"]+','+trackFeatures[i]["instrumentalness"]+','+trackFeatures[i]["liveness"]+','+trackFeatures[i]["loudness"]+','+trackFeatures[i]["speechiness"]+','+trackFeatures[i]["valence"]+','+trackFeatures[i]["danceability"]+','+trackFeatures[i]["acousticness"]+','+trackFeatures[i]["tempo"]+'\n';
				}
			}
			download(csv, "extractedFeatures.csv", "text/plain");
		}

	</script>
</head>
<body>
</body>
</html>