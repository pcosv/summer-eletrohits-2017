<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script type="text/javascript" src= "urls.json"></script>
	<script type="text/javascript" src= "trackArtists.json"></script>
	<script type="text/javascript" src= "trackFeatures.json"></script>
	<script type="text/javascript" src= "artistsGenres.json"></script>
	<script type="text/javascript" >

		var uri = '';
		var genre = '';
		var respostaArtists = new Array();
		var respostaFeatures = new Array();
		var respostaGenres = new Array();
		var count = 0;
		var token = 'BQDPAM2h74frOlJWFOqQmFO3vJgfjJoss-qrdaoW516PSp2WjRLeTPrRQGgSdB3t6fNHif7vACi7XYn4BoWlZik4Sx6MAXwSJT4ufUyskN7myRLSK_QbMNEDzFQHMeyPwce3JXRkD7quxgIVKDib3JFJ';

		function download(data, filename, type) {
			var file = new Blob([data], {type: type});
			if (window.navigator.msSaveOrOpenBlob) // IE10+
				window.navigator.msSaveOrOpenBlob(file, filename);
			else { // Others
				var a = document.createElement("a"),
					url = URL.createObjectURL(file);
				a.href = url;
				a.download = filename;
				document.body.appendChild(a);
				a.click();
				setTimeout(function() {
					document.body.removeChild(a);
					window.URL.revokeObjectURL(url);  
				}, 0); 
			}
		}

		function getArtists(){
			for(var i = 0; i < 217; i++){

				setTimeout(function(count) {

					for (var j = 0; j < 50; j++) {
						if(j != 49){
							uri += urls[count][j] + ',';
						} else {
							uri += urls[count][j];
						}
					}
					$.ajax({
						url: 'https://api.spotify.com/v1/tracks?ids=' + uri+'&market=BR',
						type: 'GET',
						headers: {
							'Authorization' : 'Bearer ' + token
						}, success: function(data) {
							for (var i = 0; i < 50; i++) {
								respostaArtists = respostaArtists.concat(JSON.parse( "{ \"song\" : \""+data["tracks"][i]["id"]+"\",  \"id\" :\""+data["tracks"][i]["artists"][0]["id"]+"\", \"name\" : \""+data["tracks"][i]["artists"][0]["name"].replace("\"", "'").replace("\"", "'").replace("\\", "")+"\"}" ));
							}
						}
					});
					uri = '';
					console.log(count);
				}, 240*i, i);

				setTimeout(function(count) {

					for (var j = 50; j < 100; j++) {
						if(j != 99){
							uri += urls[count][j] + ',';
						} else {
							uri += urls[count][j];
						}
					}
					$.ajax({
						url: 'https://api.spotify.com/v1/tracks?ids=' + uri+'&market=BR',
						type: 'GET',
						headers: {
							'Authorization' : 'Bearer ' + token
						}, success: function(data) {
							for (var i = 0; i < 50; i++) {

								respostaArtists = respostaArtists.concat(JSON.parse( "{ \"song\" : \""+data["tracks"][i]["id"]+"\",  \"id\" :\""+data["tracks"][i]["artists"][0]["id"]+"\", \"name\" : \""+data["tracks"][i]["artists"][0]["name"].replace("\"", "'").replace("\"", "'").replace("\\", "")+"\"}" ));
							}
						}
					});
					uri = '';
					console.log(count);
				}, 240*(i+0.5), i);
			}
			
		}

		// download(JSON.stringify(respostaArtists, null, "\t"), "trackArtists.json", "text/plain");

		function getFeatures(){
			for(var i = 0; i < 217; i++){

				setTimeout(function(count) {

					for (var j = 0; j < 100; j++) {
					
						uri += urls[count][j] + ',';

					}
					$.ajax({
						url: 'https://api.spotify.com/v1/audio-features?ids=' + uri,
						type: 'GET',
						headers: {
							'Authorization' : 'Bearer ' + token
						}, success: function(data) {
							respostaFeatures = respostaFeatures.concat(data["audio_features"]);
						}
					});
					uri = '';
	
				}, 120*i, i);
			}
		}

		// download(JSON.stringify(respostaFeatures, ["id", "energy", "loudness", "speechiness", "instrumentalness", "liveness", "valence", "id"], "\t"), "trackFeatures.json", "text/plain");
		
		function getGenres(){

			var uris = '';
			for(var i = 0; i < 21700; i++){
				if(uris){
					uris += ','+respostaArtists[i]["id"];
				} else {
					uris += respostaArtists[i]["id"];
				}
				
				if((i+1)%50 === 0 && i !== 0){

					setTimeout(function(uri) {

					$.ajax({
						url: 'https://api.spotify.com/v1/artists?ids=' + uri ,
						type: 'GET',
						headers: {
							'Authorization' : 'Bearer ' + token
						}, success: function(data) {
								for (var j = 0; j < 50; j++) {
									if(!genre){
										genre += "{ \""+data["artists"][j]["id"]+"\" : \"/"+data["artists"][j]["genres"].join('/')+"/\""
									} else {
										genre += ", \""+data["artists"][j]["id"]+"\" : \"/"+data["artists"][j]["genres"].join('/')+"/\"";
									}
								}
							}
						});
					}, 120*(i/50), uris);

					uris = '';
				}
				respostaGenres = JSON.parse(genre+"}");

				for (var i = 0; i < 21700; i++){
					respostaArtists[i].genres = respostaGenres[respostaArtists[i]["id"]];
				}
			}
		}

		// download(JSON.stringify(respostaGenres, null, "\t"), "artistsGenres.json", "text/plain");

	</script>
</head>
<body>
</body>
</html>